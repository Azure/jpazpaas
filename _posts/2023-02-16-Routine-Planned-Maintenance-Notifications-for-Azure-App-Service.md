---
title: "Azure App Service の計画メンテナンスの事前通知"
author_name: "Masafumi Kokui"
tags:
    - App Service
    - Function App
    - Web Apps
    - App Service Environment
---

# はじめに

本記事は 2022 年 2 月 1 日に公開されました [Routine Planned Maintenance Notifications for Azure App Service](https://azure.github.io/AppService/2022/02/01/App-Service-Planned-Notification-Feature.html) の日本語訳です。(現在の内容に合わせて一部変更を行っています。)

App Service は、新しい機能、新しいランタイムバージョン、パフォーマンスの改善、および不具合修正のために定期的に更新されます。お客様から頂戴しますご要望の 1 つにプラットフォームの更新が発生する前に通知を受け取ることができる機能がございました。このたび、2022 年 3 月上旬より、App Service Environments V3 (ASE v3) およびマルチテナントで動作するアプリケーション (App Service / 関数アプリ 等) を対象として、App Service の計画メンテナンスの事前通知がご利用いただけるようになりますことをお知らせいたします。

この通知機能により、プラットフォームのアップグレード開始前、アップグレード進行中、アップグレード完了時に、電子メールまたは SMS によるアラートを受け取ることができます。また、アップグレードの準備に時間をかけられるよう、より高度な 7 日前通知オプションも用意されています。この 7 日前通知では、イベント開始の約 1 週間前にプラットフォームのアップグレードが予定されていることをお客様にお知らせいたします。また、この通知に基づいて関数アプリやロジック アプリを呼び出すことができます。この記事では、これらのイベントを処理するために、メールと SMS アラート、および関数アプリとロジック アプリを設定する方法を説明します。重要なセキュリティの更新などについては、更新を反映させるための時間的制約があるため、事前通知を送信することができない場合があります。十分な時間的余裕がない場合には、アップグレード開始前、アップグレード進行中、アップグレード完了の通知のみが送信され、7 日前の通知は送信されない場合があります。


# 概要
App Service のメンテナンス通知は、モニターのイベントとして表示されます。つまり、通知が発生したときのメールアドレスや SMS の電話番号を設定することができます。また、カスタムの関数アプリやロジック アプリにトリガーを設定することで、リソースに対して自動的にアクションを起こすことができます。例えば、あるリージョンの App Service Environment がアップグレードされる場合に、その影響を避けるために、すべてのトラフィックを別のリージョンの App Service Environment に自動的に振り向けることができます。そして、アップグレード完了後に、自動的にトラフィックを通常に戻すこともできます。詳しくは、[Azure App Service のトラフィックを自動で振り分けるロジック アプリのサンプル](https://github.com/Azure-Samples/azure-logic-app-traffic-update-samples)を参照ください。

# アップグレードの通知を表示する
Azure ポータルから、**Home** > **モニター** > **Service Health** > **計画メンテナンス** を選択します。ここでは、選択したサブスクリプションのアクティブな (予定、または進行中のものを含む) 通知を見ることができます。App Service のアップグレード イベントは、「サービス」ボックスをクリックし、すべての App Service タイプにチェックを入れ、それ以外のチェックを外してください。過去の通知を見るには、**正常性の履歴** に移動し、「正常性イベントの種類」ボックスから **計画メンテナンス** のみをチェックします。

![image-f807211b-0f95-4a74-a5ea-a45fd93b6a71.png]({{site.baseurl}}/media/2023/02/image-f807211b-0f95-4a74-a5ea-a45fd93b6a71.png)

# アラートを設定する
1. **Azureポータル**にサインインします。
2. **モニター**アイコンをクリックします。表示されない場合は、**すべてのサービス**から、**モニター**を検索します。
3. 左メニュー項目の **Service Health** をクリックします。
4. 中央上部にある**サービス正常性アラートの作成**をクリックします。
6. 「スコープ」セクションで、App Service Environment、またはマルチテナントで動作するアプリケーション (複数可) を所有するサブスクリプションを選択します。
7. 「条件」セクション の 「サービス」ボックスで、App Service　で始まるすべての項目を選択します。
- App Service
- App Service (Linux)
- App Service (Linux) \ Web App for Containers
- App Service (Linux) \ Web Apps
- App Service \ Web Apps
8. 「地域」ボックスで、App Service Environment の地域、またはマルチテナントで動作するアプリケーションがデプロイされた地域にチェックを入れます。
9. 「イベントの種類」ボックスで、**計画メンテナンス** にチェックを入れます。
10. 「アクション」セクションで、**アクション グループの作成** をクリックします。
11. [基本] セクションで App Service Environment、またはマルチテナントで動作するアプリケーションがデプロイされたサブスクリプションを選択します。
13. リソースグループを選択し、アクショングループに名前を付けます。「表示名」をアクションを簡単に識別できるものに設定します (**重要**：「表示名」は、通知のすべてのメール/SMS/通知に表示されます)。
14. テキスト通知を受け取りたい場合は、[通知] セクションで、[通知タイプ] で **電子メール/SMS　メッセージ/プッシュ/音声** を選択します。次に、必要な出力チャンネルを選択します　(例えば、電子メールや SMS )。必要に応じて、電子メールアドレスや電話番号を入力します。
15. カスタムオートメーションをフックアップしたい場合は、[アクション] セクションで、[アクション タイプ] に **Azure 関数**、または **ロジック アプリ** を選択します。アプリを選択し、名前を入力します。
17. **確認と作成** をクリックし、**作成** をクリックします。アラートルールの作成ページに戻ります。
17. [詳細] セクションで、「アラート ルール名」を入力します。
18. **確認と作成** をクリックし、**作成** をクリックします。

# その他のリソース
- [Azure Monitor のドキュメント](https://docs.microsoft.com/azure/azure-monitor/)
- [共通アラート スキーマ](https://docs.microsoft.com/azure/azure-monitor/alerts/alerts-common-schema-definitions)
- [Azure App Service のトラフィックを自動で振り分ける Logic App サンプル](https://github.com/Azure-Samples/azure-logic-app-traffic-update-samples)

# FAQ
## アップグレードの通知はいつ届きますか？
アップグレードが開始される約 7 日前に最初の通知が作成されます。その後、メンテナンス開始の 60 ～ 90 分前とアップグレード開始時に通知が送信されます。アップグレードが開始されると、アップグレードが完了するまで 12 時間ごとに進行中の通知が送信されます。終了後、完了通知が送信されます。

## アップグレードは正確に 7 日後に行われるのでしょうか？
アップグレードが行われる正確なタイミングは、いくつかの要因によって変動するため、正確に 7 日後ではありません。アップグレードが開始される直前にも通知が届きますのでご確認ください。

## ASE で 7 日前通知が利用できるようになるのはいつですか？
7 日前通知は ASE には適用されませんが、ASE v3 では計画メンテナンスを適用するタイミングと方法を指定することができます。詳しくは、[App Service Environment の計画メンテナンスのアップグレード設定](https://learn.microsoft.com/azure/app-service/environment/how-to-upgrade-preference) を参照ください。

## アプリのアップグレードにはどれくらいの時間がかかりますか？
全世界のアップデートに要する時間は、通常 10 営業日程度となります。これは、各地域ごとのアップグレードが営業時間外に開始され、同時にペアとなる地域 (例えば、東日本と西日本) に同時にアップグレードが行われることを避けるためです。

## App Serviceのバージョンアップのお知らせが届かないのはなぜですか？
主に 2 つの理由が考えられます。1 つ目の理由は、お客様が上記の表示／通知手順に何か漏れのある可能性があります。手順に誤りがなにか改めてご確認ください。2 つ目の理由は、実施されたアップグレードがセキュリティパッチまたは Hot fix の一部であり、事前に通知を行うための十分な期間がなかった可能性があります。

## 進行中の通知を受け取る前に、7日前の事前通知を受け取らなかったのはなぜですか？ 
予定外のメンテナンスイベント (Hotfixまたは重要なセキュリティパッチ) であったと考えられます。弊社では、リソースのセキュリティ確保に取り組んでいるため、これらの懸念に対応するためのアップデートを反映する際に、常に 7 日間の余裕を確保できるとは限りません。このような通知には、通知タイトルに予定外のメンテナンスと明記されます。

## アップグレードの通知を受け取りましたが、App Service 上でアプリケーションの再起動やインスタンスの移動が確認できません。何のためにアラートを受け取ったのですか？
通常、アップグレードがまだ特定の地域で実行中であり、お客様の App Service に到達していない可能性が考えられます。

## 通知が来たときに、関数アプリを起動できますか？
はい、関数アプリやロジック アプリを起動するアクションを設定することができます。しかしながら、7 日前の通知に基づいた自動化を設定されないことをお勧めします。7 日前の通知は認識するためのものであり、開始前、進行中、完了時のフォローアップ通知を使用することでより正確にアクションを実行することができます。例として、[Azure App Service のトラフィックを自動で振り分ける Logic App サンプル](https://github.com/Azure-Samples/azure-logic-app-traffic-update-samples)をご確認ください。

通知のデータ形式は、[共通アラートスキーマの定義](https://docs.microsoft.com/azure/azure-monitor/alerts/alerts-common-schema-definitions)をご確認ください。

## App Service のメンテナンスに関する資料はありますか？
こちらの記事があります。
- [Azure App Service での OS とランタイムのパッチ適用](https://learn.microsoft.com/azure/app-service/overview-patch-os-runtime)
- [Routine (planned) maintenance for App Service](https://learn.microsoft.com/azure/app-service/routine-maintenance)
- [Demystifying the magic behind App Service OS updates](https://azure.github.io/AppService/2018/01/18/Demystifying-the-magic-behind-App-Service-OS-updates.html)
<br>
<br>

---

<br>
<br>

2023 年 02 月 16 日時点の内容となります。<br>
本記事の内容は予告なく変更される場合がございますので予めご了承ください。

<br>
<br>